<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<title>EaselJS Example: Text</title>

	<link href="css/style.css" rel="stylesheet" type="text/css" />
	<!-- We also provide hosted minified versions of all CreateJS libraries.
	  http://code.createjs.com -->
	<script src="http://code.createjs.com/easeljs-0.4.2.min.js"></script>
	<script src="http://code.createjs.com/preloadjs-0.1.0.min.js"></script>
	<script src="http://code.createjs.com/soundjs-0.2.0.min.js"></script>
	<script src="http://code.createjs.com/tweenjs-0.2.0.min.js"></script>
	<script src="http://code.createjs.com/movieclip-0.4.1.min.js"></script>
	

	<script src="js/Ingredient.js"></script>
	<script src="js/State.js"></script>
	<script>
	var canvas;
	var stage;
	var text;
	var ingredients = ["onion", "tomato", "egg", "cheese", "meat", "lettuce", "top"];
	var base;
	
	var KEYCODE_ENTER = 13;		//usefull keycode
	var KEYCODE_SPACE = 32;		//usefull keycode
	var KEYCODE_UP = 38;		//usefull keycode
	var KEYCODE_LEFT = 37;		//usefull keycode
	var KEYCODE_RIGHT = 39;		//usefull keycode
	var KEYCODE_W = 87;			//usefull keycode
	var KEYCODE_A = 65;			//usefull keycode
	var KEYCODE_D = 68;			//usefull keycode
	
	var lfHeld;
	var rtHeld;
	
	var catched=[];
	
	//register key functions
	document.onkeydown = handleKeyDown;
	document.onkeyup = handleKeyUp;
	
	function init() {
		canvas = document.getElementById("mainCanvas");
		// create a stage object to work with the canvas. This is the top level node in the display list:
		stage = new Stage(canvas);

		text = new Text("Sky Burger", "36px Arial", "#777");
		stage.addChild(text);
		text.x = 360;
		text.y = 200;

		base = new Ingredient('bottom');
		base.x = canvas.width/2;
		base.y = canvas.height;
		base.catched = true;
		catched.push(base);
		
		// call update on the stage to make it render the current display list to the canvas:
		stage.update();
		canvas.onclick = handleClick;

		function onEnterMenu()
		{
			console.log( "enter menu" );
		}
		function onExitMenu()
		{
			console.log( "exit menu" );
		}
		var menuState = new State( onEnterMenu, onExitMenu );
		SM.RegisterState( "menu", menuState );

		SM.SetStateByName( "menu" );
	}
	
	function handleClick() {
		//prevent extra clicks and hide text
		canvas.onclick = null;
		stage.removeChild(text);

		restart();
	}
	
	//allow for WASD and arrow control scheme
	function handleKeyDown(e) {
		//cross browser issues exist
		if(!e){ var e = window.event; }
		switch(e.keyCode) {
			case KEYCODE_LEFT:	lfHeld = true; return false;
			case KEYCODE_RIGHT: rtHeld = true; return false;
		}
	}

	function handleKeyUp(e) {
		//cross browser issues exist
		if(!e){ var e = window.event; }
		switch(e.keyCode) {
			case KEYCODE_LEFT:	lfHeld = false; break;
			case KEYCODE_RIGHT: rtHeld = false; break;
		}
	}
	
	//reset all game logic
	function restart() {
		//hide anything on stage and show the score
		stage.removeAllChildren();

		//ensure stage is blank and add the ship
		stage.clear();
		
		//create flowers
		for(var i=0; i<10; i++ ){
			var ingredient = new Ingredient(ingredients[Math.random()*ingredients.length|0]);
			ingredient.x = Math.random() * canvas.width % canvas.width;
			ingredient.y =  - i*100;
			stage.addChild(ingredient);
		}
		
		
		stage.addChild(base);
		//start game timer
		Ticker.addListener(window);
		
		
	}
	
	function abs(lvalue, rvalue)
	{
		if(lvalue-rvalue > 0)
			return (lvalue-rvalue);
		else 
			return rvalue-lvalue;
	}
	function handleInteraction()
	{
		var l = stage.getNumChildren();
		for (var i=0; i<l; i++) {
			var ingredient = stage.getChildAt(i);
			if( abs(ingredient.x, base.x) < 20 && (base.y-catched.length*34)-(ingredient.y+ingredient.vy) < 5 && !ingredient.catched ) {
				ingredient.catched = true;
				ingredient.x = base.x;
				ingredient.y = base.y;
				catched.push(ingredient);
				
			}
		}
	}
	
	function tick() {

		var w = canvas.width;
		var h = canvas.height;
		var l = stage.getNumChildren();

		handleInteraction();
		// iterate through all the children and move them according to their velocity:
		for (var i=0; i<l; i++) {
			var ingredient = stage.getChildAt(i);
			if( !ingredient.catched ){ 
				ingredient.y= (ingredient.y+ingredient.vy);
				if(ingredient.y>h) {
					ingredient.y = -900;
				}
			}
		}
		for(var i=0; i<catched.length; i++) {
			catched[i].y = h-34*(i+1);
			if(lfHeld) {
				catched[i].x = catched[i].x-13;
			}
			if(rtHeld) {
				catched[i].x = catched[i].x+13;
			}
		}
		// draw the updates to stage:
		stage.update();
	}
	</script>
</head>
	
<body onload="init();">

	<header id="header" class="EaselJS">
	</header>

	<div id="canvasHolder">
		<canvas id="mainCanvas" width="980" height="620"></canvas>
	</div>
</body>
</html>
